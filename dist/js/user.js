define(["jquery","fullpage","scrollbar","clipboard","base","common"],function(e,s,t,o,n,a){function r(e){$(".list-button button").eq(0).hasClass("button-hollow-not")||$.ajax({url:"/v1/User/allread.action",data:{system:e},type:"get",cache:!1,dataType:"json",success:function(e){var s=$(".news-list li.noread").length;y(s),$(".list-button button").eq(0).removeClass("button-hollow").addClass("button-hollow-not"),$(".news-list li").removeClass("noread"),$(".news-list").hasClass("news-user-list")?$(".user-tab span").removeClass("news-user-notice"):$(".sys-tab span").removeClass("news-user-notice")},error:function(){n.notice("网络错误")}})}function i(e,s){$.ajax({url:"/v1/User/isread.action",data:{msgid:e},type:"get",cache:!1,dataType:"json",success:function(e){if(s.hasClass("noread")){y(1),s.removeClass("noread");var t=!k(s);t&&($(".news-list").hasClass("news-user-list")?$(".user-tab span").removeClass("news-user-notice"):$(".sys-tab span").removeClass("news-user-notice"),$(".list-button button").eq(0).removeClass("button-hollow").addClass("button-hollow-not"))}},error:function(){n.notice("网络错误")}});var t=s.attr("data-type_id");if(t<2e4){var e=s.attr("data-msg_id");h(e)}}function l(){$.ajax({url:"/v1/user/is_email_validated.action",data:{},type:"get",cache:!1,dataType:"json",success:function(e){111001013===e.code?($(".set-form-send").removeClass("hidden"),"true"!==localStorage.getItem("emailChange")?$(".set-form-email").removeClass("warning"):($(".set-form-email").addClass("warning"),localStorage.removeItem("emailChange")),n.userInfo.isValid=!1):0===e.code&&(n.userInfo.isValid=!0,$(".set-form-send").addClass("hidden"))},error:function(){n.notice("网络错误")}})}function c(){console.log(_||$(".set-avatar img").attr("src"),_,$(".set-avatar img").attr("src"),T),$.ajax({url:"/v1/User/saveuser.action",data:{email:n.userInfo.email||$(".set-form-email").val(),phone:n.userInfo.phone||$(".set-form-phone").val(),school:n.userInfo.school||$(".set-form-school").val(),major:n.userInfo.major||$(".set-form-major").val(),nianji:n.userInfo.grade||$(".set-form-grade").val(),country:n.userInfo.country||$(".set-form-country").val(),headerimg:_||$(".set-avatar img").attr("src")},type:"post",cache:!1,dataType:"json",success:function(e){0==e.code?(clearInterval(x),$(".set-form-send").text("验证"),$(".set-info-save").removeClass("button-solid").addClass("button-solid-ban"),$(".set-form-send").removeClass("button-hollow-not").addClass("button-hollow"),console.log(_!==T,_,T),_!==T&&$(".header-user-info-avatar").attr("src",_),U=n.userInfo.phone||$(".set-form-phone").val(),O=n.userInfo.school||$(".set-form-school").val(),D=n.userInfo.major||$(".set-form-major").val(),F=n.userInfo.grade||$(".set-form-grade").text(),S=n.userInfo.country||$(".set-form-country").text(),T=_||$(".set-avatar img").attr("src"),n.userInfo.email&&n.userInfo.email!==P?(A=!0,$(".set-form-send").trigger("click"),l()):(n.notice("信息已保存"),l(),P=n.userInfo.email||$(".set-form-email").val())):n.notice(e.msg)},error:function(){n.notice("网络错误")}})}function d(){$.ajax({url:"/v1/User/saveuserbase.action",data:{password:n.userInfo.password,old_password:n.userInfo.oldpassword},type:"post",cache:!1,dataType:"json",success:function(e){0===e.code?($(".set-password-save").removeClass("button-solid").addClass("button-solid-ban"),n.notice("信息已保存"),$(".set-tab-password input").val("")):111002005===e.code?n.notice("原密码输入错误"):111002004===e.code?n.notice("新密码不能与旧密码相同"):n.notice(e.msg)},error:function(){n.notice("网络错误")}})}function u(){$.ajax({url:"/v1/account/send_register_valid_email.action",data:{},type:"POST",cache:!1,dataType:"json",success:function(e){0==e.code?n.notice("已向"+$(".set-form-email").val()+"发送了一封验证邮件，请查收"):console.log(e.msg)},error:function(){n.notice("网络错误")}})}function f(){n.userInfo.credit=$(".point-line-number2").html()||0;var e=$(".point-line").innerWidth(),s=e*n.userInfo.credit/n.userInfo.totalCredit;$(".point-line-now").css("width",s),$(".point-line-arrow").css("left",s),$(".point-line-number2").css("left",s)}function m(){$(".point-view").removeClass("hidden").addClass("animated fadeInDown").one(n.animationend,function(){$(".point-view").removeClass("animated fadeInDown")})}function p(){$(".point-view").addClass("animated fadeOutUp").one(n.animationend,function(){$(".point-view").removeClass("animated fadeOutUp").addClass("hidden")})}function v(){$(".mask").removeClass("hidden").addClass("animated fadeIn").one(n.animationend,function(){$(".mask").removeClass("animated fadeIn")}),$(".point-list").removeClass("hidden").addClass("animated fadeInDown").one(n.animationend,function(){$(".point-list").removeClass("animated fadeInDown")})}function w(){$(".mask").addClass("animated fadeOut").one(n.animationend,function(){$(".mask").removeClass("animated fadeOut").addClass("hidden")}),$(".point-list").addClass("animated fadeOutUp").one(n.animationend,function(){$(".point-list").removeClass("animated fadeOutUp").addClass("hidden")})}function h(e){$(".news-article").removeClass("hidden").addClass("animated fadeInDown").one(n.animationend,function(){$(".news-article").removeClass("animated fadeInDown")}),$(".user-main").addClass("disabled"),$.ajax({url:"/User/msganswer.action",data:{msg_id:e},type:"get",cache:!1,dataType:"html",success:function(e){$("#msganswer").html(e),$("body").css("overflow","hidden"),$("#news-content").scrollbar()},error:function(){n.notice("网络错误")}})}function C(){$(".news-article").addClass("animated fadeOutUp").one(n.animationend,function(){$(".news-article").removeClass("animated fadeOutUp").addClass("hidden")}),$(".user-main").removeClass("disabled")}function b(e,s){$(".news-delete").removeClass("hidden").addClass("animated fadeInDown").one(n.animationend,function(){$(".news-delete").removeClass("animated fadeInDown")}),$(".user-main").addClass("disabled"),$(".news-delete-ensure").on("click",function(t){$.ajax({url:"/v1/User/delmsg.action",data:{msgid:e},type:"get",cache:!1,dataType:"json",success:function(e){if(0===e.code){if(j(),s.hasClass("noread")){y(1),s.removeClass("noread");var t=!k(s);t&&($(".news-list").hasClass("news-user-list")?$(".user-tab span").removeClass("news-user-notice"):$(".sys-tab span").removeClass("news-user-notice"),$(".list-button button").eq(0).removeClass("button-hollow").addClass("button-hollow-not"))}s.remove(),0===$(".news-list li").length&&I()}},error:function(){n.notice("网络错误")}})})}function g(e,s){$(".news-delete").removeClass("hidden").addClass("animated fadeInDown").one(n.animationend,function(){$(".news-delete").removeClass("animated fadeInDown")}),$(".user-main").addClass("disabled"),$(".news-delete-ensure").on("click",function(s){$.ajax({url:"/v1/User/delallmsg.action",data:{system:e},type:"get",cache:!1,dataType:"json",success:function(s){if(0===s.code){j();var t=$(".news-list li.noread").length;y(t),$(".list-button button").eq(0).removeClass("button-hollow").addClass("button-hollow-not"),$(".news-list li").removeClass("noread"),e?$(".sys-tab span").removeClass("news-user-notice"):$(".user-tab span").removeClass("news-user-notice"),$(".news-list").empty(),I()}},error:function(){n.notice("网络错误")}})})}function I(){$(".news-tab .list-button").addClass("hidden"),$(".news-tab .news-list-none").removeClass("hidden")}function y(e){var s=$(".newsCenter .header-news-tab"),t=s.text();t-e>=1?s.text(t-e):s.removeClass("header-news-number").text("")}function k(e){var s=e.parent().find("li"),t=Array.prototype.slice.call(s);return t.some(function(e,s,t){return $(e).hasClass("noread")})}function j(){$(".news-delete").addClass("animated fadeOutUp").one(n.animationend,function(){$(".news-delete").removeClass("animated fadeOutUp").addClass("hidden")}),$(".user-main").removeClass("disabled")}var x,_,P=$(".set-form-email").val(),U=$(".set-form-phone").val(),O=$(".set-form-school").val(),D=$(".set-form-major").val(),F=$(".set-form-grade .form-select-value").text(),S=$(".set-form-country .form-select-value").text(),T=$(".set-avatar img").attr("src");console.log(T);var A=!1;return $(function(){function e(){console.log($(".set-form-email").val(),P,$(".set-form-grade .form-select-value").text(),F,$(".set-form-country .form-select-value").text(),S,n.userInfo.major,D),console.log($(".set-form-email").val()!==P,$(".set-form-phone").val()!==U,$(".set-form-grade .form-select-value").text()!==F,$(".set-form-country .form-select-value").text()!==S,$(".set-form-school").val()!==O,$(".set-form-major").val()!==D,$(".set-avatar img").attr("src")!==T,$(".set-avatar img").attr("src"),T),$(".set-form-email").val()!==P||$(".set-form-phone").val()!==U||$(".set-form-grade .form-select-value").text()!==F||$(".set-form-country .form-select-value").text()!==S||$(".set-form-school").val()!==O||$(".set-form-major").val()!==D||$(".set-avatar img").attr("src")!==T?$(".set-info-save").removeClass("button-solid-ban").addClass("button-solid"):$(".set-info-save").removeClass("button-solid").addClass("button-solid-ban")}if(f(),l(),$("#grade-option")[0]&&$("#grade-option").scrollbar(),$("#country-option")[0]&&$("#country-option").scrollbar(),$("#news-content")[0]&&$("#news-content").scrollbar(),$(".set-tab").tab(),$(".news-tab").tab(),$(".set-form-grade").select(),$(".set-form-country").select(),$(".set-avatar-change")[0]){Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"userAvatar",uptoken_url:"/v1/help/qiqiuauth.action",domain:"http://oi7kb12ow.bkt.clouddn.com/",get_new_uptoken:!1,max_file_size:"100mb",flash_swf_url:"//cdn.bootcss.com/plupload/2.1.9/Moxie.swf",max_retries:3,dragdrop:!0,drop_element:"container",chunk_size:"4mb",auto_start:!0,multi_selection:!1,filters:{prevent_duplicates:!0,mime_types:[{title:"Image files",extensions:"jpg,gif,png"}]},init:{FilesAdded:function(e,s){plupload.each(s,function(e){})},BeforeUpload:function(e,s){if(console.log(s.size,s,s.size>5e6),s.size>5e6)return void n.notice("上传图片大小不得超过5MB")},UploadProgress:function(e,s){},FileUploaded:function(s,t,o){var a=JSON.parse(o);_=s.getOption("domain")+a.key,n.userInfo.headerimg=_,$(".user-main .set-avatar img").attr("src",_),e(),key=""},Error:function(e,s,t){},UploadComplete:function(){},Key:function(e,s){var t="/usr/upload/"+e.uid;return t}}})}$(".set-form-email").on("blur",function(){$(".set-form-email").testInput({rule:n.emailRule,success:function(s){n.userInfo.email=s.val(),console.log(n.userInfo.email,P),n.userInfo.email!==P&&(n.testEmail(s),clearInterval(x),$(".set-form-send").text("验证").removeClass("hidden"),$(this).removeClass("warning"),$(".set-form-send").addClass("button-hollow-not").removeClass("button-hollow"),e())},fail:function(e){n.userInfo.email="",n.testFail(e,"请输入有效的 Email 地址")}})}),$(".set-form-send").on("click",function(){if(!$(this).hasClass("button-hollow-not")){console.log($(".set-form-email").val(),P,n.userInfo.email),$(this).removeClass("button-hollow").addClass("button-hollow-not"),A?(n.notice("已向"+$(".set-form-email").val()+"发送了一封验证邮件，请查收"),A=!1,P=n.userInfo.email):u();var e=60;x=setInterval(function(){e-=1,$(".set-form-send").text(e+"秒可重发"),e<=0&&(clearInterval(x),$(".set-form-send").removeClass("button-hollow-not").addClass("button-hollow"),$(".set-form-send").text("验证"))},1e3)}}),$(".set-form-phone").on("blur",function(){$(".set-form-phone").testInput({rule:n.phoneRule,success:function(s){n.userInfo.phone!==U&&(n.userInfo.phone=s.val(),n.testSuccess(s),n.testPhone(s),e())},fail:function(e){n.userInfo.phone="",n.testFail(e,"请输入有效的手机号")}})}),$(".set-form-school").on("input propertychange",function(){$(".set-form-school").testInput({rule:n.isOtherInput,success:function(s){n.userInfo.school="",n.testFail(s,"请输入正确的学校名称"),e()},fail:function(s){n.testSuccess(s),n.userInfo.school=s.val(),e()}})}),$(".set-form-major").on("input propertychange",function(){$(".set-form-major").testInput({rule:n.isOtherInput,success:function(s){n.userInfo.major="",n.testFail(s,"请输入正确的专业名称"),e()},fail:function(s){n.testSuccess(s),n.userInfo.major=s.val(),e()}})}),$(".set-form-grade .form-select-option li").on("click",function(){n.userInfo.grade=$(this).html(),e()}),$(".set-form-country .form-select-option li").on("click",function(){n.userInfo.country=$(this).html(),e()}),$(".set-info-save").on("click",function(){var e=$(".set-form-info").find("input"),s=Array.prototype.slice.call(e),t=s.some(function(e,s,t){return $(e).hasClass("error")});!t&&$(this).hasClass("button-solid")&&c()}),$(".set-form-oldpassword").on("blur",function(){$(".set-form-oldpassword").testInput({rule:n.passwordRule,success:function(e){n.userInfo.oldpassword=e.val(),n.testSuccess(e)},fail:function(e){n.userInfo.oldpassword="",n.testFail(e,"请输入8位以上密码且必须含有数字、小写及大写字母")}})}),$(".set-form-password").on("blur",function(){$(".set-form-password").testInput({rule:n.passwordRule,success:function(e){return n.userInfo.password=e.val(),n.userInfo.password===n.userInfo.oldpassword?void n.testFail(e,"新密码不能和原始密码相同"):void n.testSuccess(e)},fail:function(e){n.userInfo.password="",n.testFail(e,"请输入8位以上密码且必须含有数字、小写及大写字母")}})}),$(".set-form-repassword").on("blur",function(){var e=$(this);n.userInfo.password&&(e.val()==n.userInfo.password?(n.userInfo.repassword=e.val(),n.testSuccess(e)):(n.userInfo.repassword="",n.testFail(e,"密码不一致")))}),$(".set-tab-password input").on("input propertychange",function(){return $(".set-form-oldpassword").val()&&$(".set-form-password").val()&&$(".set-form-repassword").val()?void $(".set-password-save").removeClass("button-solid-ban").addClass("button-solid"):void $(".set-password-save").removeClass("button-solid").addClass("button-solid-ban")}),$(".set-password-save").on("click",function(){n.userInfo.oldpassword&&n.userInfo.password&&n.userInfo.repassword&&!$(".set-tab-password input").hasClass("error")&&d()}),$(".point-view").on("click",function(e){e.stopPropagation()});var s=new o("[data-clipboard-link]");s.on("success",function(e){$(".point-view-title").html("链接地址"),$(".point-result-code")[0].style.display="none",$(".point-result-site")[0].style.display="block",m()});var t=new o("[data-clipboard-code]");t.on("success",function(e){$(".point-view-title").html("邀请码"),$(".point-result-code").removeClass("hidden"),$(".point-result-site").addClass("hidden"),$(".point-result-site")[0].style.display="none",$(".point-result-code")[0].style.display="block",m()}),$(".point-view-close").on("click",function(e){e.stopPropagation(),p()}),n.closeAll.closePointView=p,$(".point-list").on("click",function(e){e.stopPropagation()}),$(".point-title a").on("click",function(e){e.stopPropagation(),v()}),$(".point-list-close").on("click",function(e){e.stopPropagation(),w()}),n.closeAll.closePointList=w,$(".point-title-share").on("mouseenter",function(){$(".point-share-notice").fadeIn(200)}),$(".point-title-share").on("mouseleave",function(){$(".point-share-notice").fadeOut(200)}),$(".news-article").on("click",".news-article-type",function(e){e.stopPropagation()}),$(".news-article").on("click",".news-article-title",function(e){e.stopPropagation()}),$(".news-article").on("click",".news-article-content",function(e){e.stopPropagation()}),$(".news-list li a").on("click",function(e){e.stopPropagation();var s=$(this).parent().attr("data-msg_id");i(s,$(this).parent())}),$(".news-list li .news-operation a").on("click",function(e){e.stopPropagation();var s=$(this).parent().parent().attr("data-msg_id");i(s,$(this).parent().parent())}),$(".news-system-read").on("click",function(e){e.stopPropagation(),r(1)}),$(".news-user-read").on("click",function(e){e.stopPropagation(),r(0)}),$(".news-article").on("click","news-article-close",function(){console.log("e"),C()}),n.closeAll.closeNewsArticle=C,$(".news-delete").on("click",function(e){e.stopPropagation()}),$(".news-list-delete").on("click",function(e){e.stopPropagation(),$(".news-delete-content p").html("是否删除此消息");var s=$(this).parent().parent(),t=s.attr("data-msg_id");console.log(s,t),b(t,s)}),$(".news-system-delete").on("click",function(e){e.stopPropagation(),$(".news-delete-content p").html("是否清空系统消息？<br/><span>此删除不可恢复，请谨慎操作</span>");var s=$(".news-system-list");g(1,s)}),$(".news-user-delete").on("click",function(e){e.stopPropagation(),$(".news-delete-content p").html("是否清空个人消息？<br/><span>此删除不可恢复，请谨慎操作</span>");var s=$(".news-user-list");g(0,s)}),$(".news-delete-cancel").on("click",function(e){e.stopPropagation(),j()}),$(".news-delete-close").on("click",function(e){e.stopPropagation(),j()}),n.closeAll.closeNewsDelete=j}),{}});