define(["jquery","handlebars","d3","fullpage","scrollbar","base","common","iscroll"],function(e,o,t,a,r,s,n,c){function i(){(j.country||j.state||j.preference||j.major||j.degree)&&$(".screen-side-search").removeClass("button-solid-ban").addClass("button-solid")}function l(e){return e?void $.ajax({url:"/schoolmajor/searchschool.action",data:{search:e,page:0},type:"get",cache:!1,dataType:"html",success:function(e){$(".screen-side-reset").trigger("click"),$("#search-result").html(e)},error:function(){s.notice("网络错误")}}):void $.ajax({url:"/schoolmajor/filterschool.action",data:{nation:j.country,state:j.state,location:j.preference,major_name:j.major,degree:j.degree,page:0},type:"get",cache:!1,dataType:"html",success:function(e){$(".screen-form-school").val(""),$("#search-result").html(e)},error:function(){s.notice("网络错误")}})}function m(e){$.ajax({url:"/completeform/chinamajor.action",data:{majorname:e},type:"post",cache:!1,dataType:"html",success:function(e){$("#select-major ul").html(e),$(".recommend-major-form").find(".form-select-option").removeClass("hidden"),$("#select-major").scrollbar()},error:function(){s.notice("网络错误")}})}function d(){j.country="",j.state="",j.preference="",j.major="",j.degree="",$(".screen-form-country .form-select-value").html("选择地区"),$("#screen-state ul").html(""),$(".screen-form-state .form-select-value").html("选择州(省)"),$(".screen-form-major .form-select-value").html("选择专业"),$(".screen-form-radio button").removeClass("active"),$(".screen-side-search").removeClass("button-solid").addClass("button-solid-ban")}function h(){var e,o,a=$(".school-brief-map").data("nation"),r=$(".school-brief-map").data("map"),s=300,n=200,c=t.select(".school-brief-map").append("svg").attr("width",s).attr("height",n).append("g").attr("transform","translate(0,0)");"US"==a?(e=t.geoAlbersUsa().translate([s/2,n/2]).scale([350]),o="/js/US.json"):"CA"==a&&(e=t.geoAlbers().center([45.4,75.5]).parallels([45,70]).scale(280).translate([.65*s,.1*n]),o="/js/CA.json");var i=t.geoPath().projection(e);t.json(o,function(e,o){return e?console.log(e):void c.selectAll("path").data(o.features).enter().append("path").attr("stroke","#999999").attr("stroke-width",1).attr("fill",function(e){return"US"==a?e.properties.name==r?"#25baf4":"#cccccc":"CA"==a?e.properties.NAME==r?"#25baf4":"#cccccc":void 0}).attr("d",i)})}function f(e){return e?void $(".recommend-major-get").removeClass("button-solid-ban").addClass("button-solid"):void $(".recommend-major-get").removeClass("button-solid").addClass("button-solid-ban")}function u(){var e=$(".major-tab .tab-title li").length;switch(e){case 1:$(".major-tab .tab-title li").css("width",150);break;case 2:$(".major-tab .tab-title li").css("width",150);break;case 3:$(".major-tab .tab-title li").css("width",100);break;case 4:$(".major-tab .tab-title li").css("width",100)}}function p(e){e.parent(".tab-title").find("li").removeClass("active"),e.addClass("active")}function g(e,o){$(".school-recommend .loader").removeClass("hidden"),e&&(console.log(e,o),$.ajax({url:"/school-mjlist-partial",data:{sid:o,value:e},type:"get",cache:!1,dataType:"html",success:function(e){$(".school-recommend .loader").addClass("hidden"),$(".school-side-revise").show(),$(".school-side-son").addClass("hidden"),$(".help-icon").removeClass("hidden"),$(".school-all-page").removeClass("active"),$(".school-recommend-page").addClass("active"),$("#school-content-page").html(e),$(".major-require-list li:first-child").trigger("click"),$(".school-brief-content").height()>0&&($(".school-brief-title").click(),$(".school-major:not(:first-child)").find(".school-box-title").trigger("click")),$(".major-require-content")[0]&&$(".major-require-content").scrollbar(),$(".major-from-content")[0]&&$(".major-from-content").scrollbar(),$(".major-info-start").select(),$(".major-info-direction").select(),$(".major-info-direction .form-select-option li").on("click",function(){$(this).html().length>20&&$(".major-info-direction .form-select-value").html($(this).html().substring(0,20)+"...")});for(var o=$(".major-email-short"),t=0;t<o.length;t++)o.eq(t).text().length>23&&(o.eq(t).text(o.eq(t).text().substring(0,23)+"..."),o.eq(t).parent().on("mouseenter",function(e){e.stopPropagation(),$(this).find(".major-email-all").removeClass("hidden")}).on("mouseleave",function(e){e.stopPropagation(),$(this).find(".major-email-all").addClass("hidden")}))},error:function(){s.notice("网络错误")}}))}function v(e){e.parent().find("li img").addClass("hidden"),e.parent().find("li img:first-child").removeClass("hidden"),e.find("img").eq(1).removeClass("hidden"),e.find("img").eq(0).addClass("hidden"),e.parents(".major-require-list").find("li").removeClass("active"),e.addClass("active"),e.parents(".major-require").find(".major-require-content-name").html(e.find(".major-require-list-name").html()),e.parents(".major-require").find(".major-require-content-result").html(e.find(".major-require-list-result").html())}var j={};j.country="",j.state="",j.preference="",j.major="",j.degree="";var C,b,y=[],x=$(".school-info").data("sid");return localStorage.getItem("userMajor")&&g(localStorage.getItem("userMajor"),x),$(function(){function e(e,o){$.ajax({url:"/school-major-partial",data:{sid:e,mid:o},type:"get",cache:!1,dataType:"html",success:function(e){$("#school-content-page").html(e),setTimeout(function(){var e=$(".school-box-content.major-tab").eq(0).data("academy");$(".school-side-son").removeClass("active"),$('.school-side-son li[data-academy="'+e+'"]').addClass("active"),$("#school-content-page .major-require-list li:eq(0)").trigger("click")},100),$(".help-icon").removeClass("hidden"),$(".major-require-content")[0]&&$(".major-require-content").scrollbar(),$(".major-from-content")[0]&&$(".major-from-content").scrollbar(),$(".major-info-start").select(),$(".major-info-direction").select(),$(".major-info-direction .form-select-option li").on("click",function(){$(this).html().length>20&&$(".major-info-direction .form-select-value").html($(this).html().substring(0,20)+"...")});for(var o=$(".major-email-short"),t=0;t<o.length;t++)o.eq(t).text().length>23&&(o.eq(t).text(o.eq(t).text().substring(0,23)+"..."),o.eq(t).parent().on("mouseenter",function(e){e.stopPropagation(),$(this).find(".major-email-all").removeClass("hidden")}).on("mouseleave",function(e){e.stopPropagation(),$(this).find(".major-email-all").addClass("hidden")}))},error:function(){s.notice("网络错误")}})}function o(e){$.ajax({url:"/school-detail-partial",data:{sid:e},type:"get",cache:!1,dataType:"html",success:function(e){$(".school-side li").removeClass("active"),$(".school-side-revise").hide(),$(".school-recommend-page").addClass("active"),$(".school-side-son").hide(),$(".help-icon").addClass("hidden"),$("#school-content-page").html(e)},error:function(){s.notice("网络错误")}})}$("#screen-state")[0]&&$("#screen-state").scrollbar(),$("#screen-major")[0]&&$("#screen-major").scrollbar(),$(".school-brief-describe")[0]&&$(".school-brief-describe").scrollbar(),$(".screen-form-country").select(),$(".screen-form-state").select(),$(".screen-form-major").select(),$(".screen-form-country .form-select-option li").on("click",function(){"全部"===$(this).text()?(console.log($(this).text()),$(".screen-form-state .form-select-value").html("全部"),$(".screen-form-state").addClass("form-select-not"),$(".screen-form-state .form-select-arrow").addClass("form-select-arrow-not"),$("#screen-state ul").html("")):($(".screen-form-state").removeClass("form-select-not"),$(".screen-form-state .form-select-arrow").removeClass("form-select-arrow-not"),$(".screen-form-state .form-select-value").html("选择州(省)"),$("#screen-state ul").html("")),j.country=$(this).attr("short_country");var e;"US"==j.country?e="js/country/US.json":"CA"==j.country&&(e="js/country/CA.json"),$.getJSON(e,function(e){for(var o="<li>全部</li>",t=0;t<e.length;t++)e[t].shortName.length>20&&(e[t].shortName=e[t].shortName.substring(0,20)+"..."),o=o+'<li short_state="'+e[t].shortName+'">'+e[t].fullName+"</li>";$(".screen-form-state .form-select-option ul").append(o)}),i()}),$(".screen-form-state .form-select-option").on("click","li",function(e){console.log(j.country,j.state),$(".screen-form-state").find(".form-select-option").removeClass("hidden"),e.stopPropagation(),j.state=$(this).attr("short_state"),$(".screen-form-state .form-select-value").html($(this).html()),$(".screen-form-state .form-select-option").addClass("hidden"),$(".screen-form-state").removeClass("focus"),i()}),$(".screen-form-major")[0]&&$.getJSON("js/country/major.json",function(e){for(var o="",t=0;t<e.length;t++)o=o+"<li>"+e[t]+"</li>";$(".screen-form-major .form-select-option ul").append(o)}),$(".screen-form-major .form-select-option").on("click","li",function(e){e.stopPropagation(),j.major=$(this).html(),$(".screen-form-major .form-select-value").html($(this).html()),$(".screen-form-major .form-select-option").addClass("hidden"),$(".screen-form-major").removeClass("focus"),i()}),$(".screen-form-preference button").on("click",function(){$(this).hasClass("active")?(j.preference="",$(this).removeClass("active"),i()):($(".screen-form-preference button").removeClass("active"),$(this).addClass("active"),j.preference=$(this).html(),i())}),$(".screen-form-degree button").on("click",function(){$(this).hasClass("active")?(j.degree="",$(this).removeClass("active"),i()):($(".screen-form-degree button").removeClass("active"),$(this).addClass("active"),j.degree=$(this).html(),i()),console.log(j.degree)}),$(".screen-side-form-search").on("click",function(){var e=$(".screen-form-school").val();l(e)}),$(".screen-form-school").on("keydown",function(e){if(13==e.keyCode){var o=$(".screen-form-school").val();l(o)}});var t=window.location.search;if("value"===t.slice(1,t.indexOf("="))){$(".screen-form-school").val(decodeURIComponent(t.slice(t.indexOf("=")+1,t.indexOf("&"))));var a=$(".screen-form-school").val();l(a)}$(".screen-side-search").on("click",function(){(j.country||j.state||j.preference||j.major||j.degree)&&l()}),$(".screen-side-reset").on("click",function(){d()}),$(".school-side").on("click",".school-recommend-page",function(e){e.stopPropagation();e.target;$(".school-box-content").hasClass("major-empty")&&(b=!0),!localStorage.getItem("userMajor")||b?o(x):(g(localStorage.getItem("userMajor"),x),b=!1)}),$(".school-side").on("click",".school-side-revise",function(e){e.stopPropagation();var t=e.target;$(t).addClass("active"),localStorage.removeItem("userMajor"),o(x)}),$(".school-all-page").on("click",function(e){e.stopPropagation();var o=e.target;$.ajax({url:"/school-all-partial",data:{sid:$(".school-side").attr("data-school")},type:"get",cache:!1,dataType:"html",success:function(e){$(".school-side li").removeClass("active"),$(o).addClass("active"),$(".school-side-revise").hide(),$(".help-icon").addClass("hidden"),$("#school-content-page").html(e)},error:function(){s.notice("网络错误")}}),$.ajax({url:"/school-academylist-partial",data:{sid:x},type:"get",cache:!1,dataType:"html",success:function(e){$(".school-side li").removeClass("active"),$(o).addClass("active"),$(".school-side-revise").hide(),$(".help-icon").addClass("hidden"),$("#academylist").html(e)},error:function(){s.notice("网络错误")}})}),$(".school-side").on("click",".school-side-son li",function(e){e.stopPropagation();var o=e.target;$.ajax({url:"/school-majorlist-partial",data:{sid:x,academy:$(this).attr("data-academy")},type:"get",cache:!1,dataType:"html",success:function(e){$(".school-side-son li").removeClass("active"),$(".school-recommend-page").removeClass("active"),$(".school-all-page").addClass("active"),$(".school-side-revise").hide(),$(".help-icon").addClass("hidden"),$(o).addClass("active"),$("#school-content-page").html(e)},error:function(){s.notice("网络错误")}})}),$("#school-content-page").on("click",".all-list li",function(o){o.stopPropagation();var t=$(this).attr("data-mid");if(t){var a=o.target;$(a).addClass("active"),e(x,t)}}),$("#school-content-page").on("click",".recommend-major-list li",function(o){o.stopPropagation();var t=$(this).attr("data-major");e(x,t)}),$(".school").on("click",".school-box .school-box-title",function(e){e.stopPropagation();var o=$(this).parents(".school-box").find(".school-box-content"),t=$(".school-box").index($(this).parents(".school-box"));y[t]?y[t]&&0!==o.innerHeight()&&(y[t]=o.innerHeight()):y[t]=o.innerHeight(),"0px"==o.css("height")?($(this).find("img").removeClass("animated rotateDown").addClass("animated rotateUp"),o.animate({height:y[t]},200)):($(this).find("img").removeClass("animated rotateUp").addClass("animated rotateDown"),o.animate({height:0},200))}),$(".school-brief-map")[0]&&h(),$("#school-content-page").on("input propertychange",".recommend-major-form input",function(){localStorage.removeItem("userMajor"),m($(this).val()),f($(this).val())}),$("#school-content-page").on("blur",".recommend-major-form input",function(){for(var e=$(".recommend-major-form input").val(),o=[],t=0;t<$(".recommend-major-form .form-select-option li").length;t++)o.push($(".recommend-major-form .form-select-option li").eq(t).html());return 0===o.length||!o.indexOf(C)==-1?(e=null,void s.testFail($(this),"请从下拉列表中选择专业")):void s.testSuccess($(this))}),$("#school-content-page").on("click",".recommend-major-form .form-select-option li",function(e){e.stopPropagation(),s.testSuccess($(".recommend-major-form input")),console.log($(this).html()),C=$(this).html(),localStorage.setItem("userMajor",C),$(".recommend-major-form input").val(C),$(".form-select-option").addClass("hidden"),$(".recommend-major-get").removeClass("button-solid-ban").addClass("button-solid"),$(".recommend-major-form input").focus()}),$("#school-content-page").on("click",".recommend-major-get",function(e){return 0===$(".recommend-major-form .form-select-option li").length?void s.testFail($(".recommend-major-form input"),"请从下拉列表中选择专业"):void g(C,x)}),$("#school-content-page").on("keydown",function(e){var e=e||window.event;if(13===e.keyCode){if($(".recommend-major-form input").trigger("blur"),0===$(".recommend-major-form .form-select-option li").length)return;g(C,x)}}),u(),$("#school-content-page").on("click",".major-tab .tab-title li",function(e){e.stopPropagation(),p($(this));e.target;$.ajax({url:"/school-major-partial",data:{mid:$(this).attr("data-mid"),majorDegree:!0},type:"get",cache:!1,dataType:"html",success:function(e){$(".help-icon").removeClass("hidden"),$(this).parents(".school-box").find(".majorDegree").addClass("animated fadeInDown").html(Math.random()),$(".major-require-content")[0]&&$(".major-require-content").scrollbar(),$(".major-from-content")[0]&&$(".major-from-content").scrollbar(),$(".major-info-start").select(),$(".major-info-direction").select(),$(".major-info-direction .form-select-option li").on("click",function(){$(this).html().length>20&&$(".major-info-direction .form-select-value").html($(this).html().substring(0,20)+"...")});for(var o=$(".major-email-short"),t=0;t<o.length;t++)o.eq(t).text().length>23&&(o.eq(t).text(o.eq(t).text().substring(0,23)+"..."),o.eq(t).parent().on("mouseenter",function(e){e.stopPropagation(),$(this).find(".major-email-all").removeClass("hidden")}).on("mouseleave",function(e){e.stopPropagation(),$(this).find(".major-email-all").addClass("hidden")}))},error:function(){s.notice("网络错误")}})}),$("#school-content-page").on("click",".major-require-list li",function(e){e.stopPropagation(),v($(this))})}),$("#search-result").on("click",".list-page li",function(){var e=$(this).find("a").data("query");return e.indexOf("search")?void $.ajax({url:"/schoolmajor/filterschool.action?"+e,data:{},type:"get",cache:!1,dataType:"html",success:function(e){$("#search-result").html(e)},error:function(){s.notice("网络错误")}}):void $.ajax({url:"/schoolmajor/searchschool.action?"+e,data:{},type:"get",cache:!1,dataType:"html",success:function(e){$("#search-result").html(e)},error:function(){s.notice("网络错误")}})}),{}});